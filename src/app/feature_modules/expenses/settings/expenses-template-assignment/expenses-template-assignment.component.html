<div class="position-relative">
    <button mat-flat-button 
    class="position-absolute end-0" 
    color="primary" 
    (click)="changeMode='Add'; clearSelection(addModal)">
    {{ 'expenses.add_new' | translate }}
    </button>
</div>
<hrm-table [data]="dataSource.data" [isServerSide]="true" [columns]="columns" [showExport]="'none'"
    [showSearch]="true" [totalItems]="totalRecords" (actionClicked)="handleAction($event, addModal)"
    (pageChanged)="onPageChange($event)" (sortChanged)="onSortChange($event)"
    (searchChanged)="onSearchChange($event)">
</hrm-table>

<!-- update template assignment -->
<ng-template #addModal>
    <div class="d-flex align-items-center justify-content-between">
        <h1 mat-dialog-title>
            @switch(changeMode){
            @case('Add'){<span translate>expenses.add </span>}
            @case('View'){<span translate>expenses.view </span>}
            @case('Update'){<span translate>expenses.update </span>}
            }
            <span translate>expenses.employee_expense_assignment</span>
        </h1>
        <button mat-icon-button mat-dialog-close="" class="me-4">
            <mat-icon>close</mat-icon>
        </button>
    </div>
    <form [formGroup]="templateAssignmentForm" (ngSubmit)="addOrUpdateAssignment()">
        <div mat-dialog-content>

            <mat-form-field class="w-100">
                <mat-label>{{'expenses.expense_template_for' | translate}}</mat-label>
                @switch(changeMode){@case('Add'){
                <mat-select [attr.disabled]="isEdit === true" formControlName="user">
                    <mat-option *ngFor="let user of getAvailableUsers()" [value]="user.id">
                        {{user?.firstName | titlecase}} {{user?.lastName | titlecase}}
                    </mat-option>
                </mat-select>
                }
                @case('Update'){
                <mat-select [attr.disabled]="isEdit === true" formControlName="user">
                    <mat-option *ngFor="let user of allAssignee" [value]="user.id">
                        {{user?.firstName | titlecase}} {{user?.lastName | titlecase}}
                    </mat-option>
                </mat-select>
                }
                }

                @if(templateAssignmentForm.get('user').touched){
                <mat-error>
                    {{'expenses.template_for_error' | translate}}
                </mat-error>}

            </mat-form-field>

            <mat-form-field class="w-100">
                <mat-label>{{'expenses.expense_template' | translate}}</mat-label>
                <mat-select formControlName="expenseTemplate" [attr.disabled]="changeMode === 'View'"
                    (selectionChange)="onTemplateSelectionChange($event)">
                    <mat-option *ngFor="let template of templates" [value]="template?._id">
                        {{template?.policyLabel}}
                    </mat-option>
                </mat-select>
                @if(templateAssignmentForm.get('expenseTemplate').touched){
                <mat-error>
                    {{'expenses.template_required' | translate}}
                </mat-error>}
            </mat-form-field>

            <div *ngIf="showApproverFields">
                <div
                    *ngIf="(templateById?.approvalType === 'template-wise' || templateById?.approvalType === 'employee-wise')">
                    <mat-form-field class="w-100">
                        <mat-label>{{'expenses.primary_approver' | translate}}</mat-label>
                        <mat-select #primaryApproverField name="member" formControlName="primaryApprover">
                            <mat-option *ngFor="let assignee of managers" [value]="assignee.id">
                                {{assignee?.firstName |titlecase}} {{assignee?.lastName | titlecase}}
                            </mat-option>
                        </mat-select>
                        @if(templateAssignmentForm.get('primaryApprover').touched){
                        <mat-error>
                            {{'expenses.first_approver_error' | translate}}
                        </mat-error>}
                    </mat-form-field>
                </div>

            </div>

            <mat-form-field class="w-50">
                <mat-label>{{'expenses.effective_date' | translate}}</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="effectiveDate">
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                @if(templateAssignmentForm.get('effectiveDate').touched) {
                <mat-error>
                    {{'expenses.date_required' | translate}}
                </mat-error>}
            </mat-form-field>
        </div>

        <div mat-dialog-actions class="d-flex align-items-center justify-content-between"
            *ngIf="changeMode == 'Add' || 'Update'">
            <div>
                <button mat-flat-button type="button"
                    (click)="templateAssignmentForm.reset(); dialogRef.close()">{{'expenses.cancel' |
                    translate}}</button>
                <!-- @if(changeMode === 'Update' || changeMode === 'Add'){
                    <button mat-stroked-button type="button" (click)="clearSelection()">{{'expenses.reset' | translate}}</button>
                } -->
            </div>
            @if(changeMode === 'Update' || changeMode === 'Add'){
            <button mat-flat-button type="submit" [disabled]="templateAssignmentForm.invalid || isSubmitted" color="primary">{{changeMode === 'Add' ? ('expenses.add' | translate)
                : ('expenses.update' | translate)}}</button>
            }
        </div>
    </form>
</ng-template>