<div class="d-flex align-items-center justify-content-between">
  <h1 mat-dialog-title>
    {{'expenses.expense_category_setting_title' | translate}} {{selectedTemplate?.policyLabel}}
  </h1>
  <button mat-icon-button mat-dialog-close="" (click)="closeModal()" class="me-4">
    <mat-icon>close</mat-icon>
  </button>
</div>
<div mat-dialog-content>
  @if(!loader){
  <mat-vertical-stepper #stepper [formGroup]="firstForm" [linear]="true">
    <ng-container *ngFor="let categoryCtrl of firstForm?.get('expenseCategories')?.controls; let i = index">
      <mat-step [stepControl]="categoryCtrl">
        <form [formGroup]="categoryCtrl">
          <ng-template matStepLabel>{{ getCategoryLabel(categoryCtrl.value._id) }}
            <span [matTooltip]="getCategoryLabel(categoryCtrl.value._id)" matTooltipPosition="below"></span>
          </ng-template>

          @if(categoryCtrl.get('categoryType').value == 'dateRange'){
          <div class="d-flex align-items-center">
            <mat-label>{{'expenses.total_amount_allowed' | translate}}</mat-label>
            <mat-checkbox color="primary" formControlName="isEmployeeCanAddInTotalDirectly"></mat-checkbox>
          </div>

          <div class="d-flex align-items-center my-2">
            <mat-label class="w-50">{{'expenses.rate_per_day' | translate}}</mat-label>
            <mat-form-field class="ms-auto">
              <input type="number" min="0" matInput formControlName="ratePerDay">
            </mat-form-field>
            @if (categoryCtrl.get('ratePerDay')?.errors?.['min']) {
            <small class="text-danger">{{ 'expenses.negativeValRestrict' | translate }}</small>
            }
            @if (categoryCtrl.get('ratePerDay')?.errors?.['required']) {
            <small class="text-danger">{{ 'expenses.requiredFields' | translate }}</small>
            }
          </div>
          }

          <div class="d-flex align-items-center">
            <mat-label class="w-50">{{'expenses.max_amount_limit_per_expense' | translate}}</mat-label>
            <div class="ms-auto">
              <mat-slide-toggle color="primary" formControlName="isMaximumAmountPerExpenseSet"></mat-slide-toggle>
            </div>
            <mat-form-field class="ms-4">
              <input type="number" min="0" matInput formControlName="maximumAmountPerExpense"
                [attr.disabled]="!categoryCtrl.get('isMaximumAmountPerExpenseSet').value ? true : null">
            </mat-form-field>
            @if (categoryCtrl.get('maximumAmountPerExpense')?.errors?.['min']) {
            <small class="text-danger">{{ 'expenses.negativeValRestrict' | translate }}</small>
            }
            @if (categoryCtrl.get('maximumAmountPerExpense')?.errors?.['required']) {
            <small class="text-danger">{{ 'expenses.requiredFields' | translate }}</small>
            }
          </div>

          <div class="d-flex align-items-center mt-2">
            <label class="w-50">{{'expenses.max_amount_limit_per_expense_without_receipt' | translate}}</label>
            <div class="ms-auto">
              <mat-slide-toggle color="primary" formControlName="isMaximumAmountWithoutReceiptSet"></mat-slide-toggle>
            </div>
            <mat-form-field class="ms-4">
              <input type="number" min="0" matInput formControlName="maximumAmountWithoutReceipt"
                [attr.disabled]="!categoryCtrl.get('isMaximumAmountWithoutReceiptSet').value ? true : null">
            </mat-form-field>
            @if (categoryCtrl.get('maximumAmountWithoutReceipt')?.errors?.['min']) {
            <small class="text-danger">{{ 'expenses.negativeValRestrict' | translate }}</small>
            }
            @if (categoryCtrl.get('maximumAmountWithoutReceipt')?.errors?.['required']) {
            <small class="text-danger">{{ 'expenses.requiredFields' | translate }}</small>
            }
          </div>

          @if(categoryCtrl.get('categoryType').value != 'dateRange'){
          <div class="d-flex align-items-center mt-2">
            <label class="w-50">{{'expenses.times_in_a' | translate}} </label>
            <div class="ms-auto">
              <mat-slide-toggle color="primary" formControlName="isTimePeroidSet"></mat-slide-toggle>
            </div>
            <mat-form-field class="ms-4">
              <mat-select formControlName="timePeroid"
                [attr.disabled]="!categoryCtrl.get('isTimePeroidSet').value ? true : null">
                <mat-option value="" disabled selected>{{'expenses.select_time' | translate}}</mat-option>
                <mat-option value="Day">{{'expenses.day' | translate}}</mat-option>
                <mat-option value="Week">{{'expenses.week' | translate}}</mat-option>
                <mat-option value="Month">{{'expenses.month' | translate}}</mat-option>
              </mat-select>
            </mat-form-field>
            @if (categoryCtrl.get('timePeroid')?.errors?.['required']) {
            <small class="text-danger">{{ 'expenses.requiredFields' | translate }}</small>
            }
          </div>

          <div class="d-flex align-items-center mt-2">
            <label class="w-50">{{'expenses.expire_after_days' | translate}} </label>
            <div class="ms-auto">
              <mat-slide-toggle color="primary" formControlName="isEmployeeCanAddInTotalDirectly"></mat-slide-toggle>
            </div>
            <mat-form-field class="ms-4">
              <input type="number" min="0" matInput formControlName="expiryDay"
                [attr.disabled]="!categoryCtrl.get('isEmployeeCanAddInTotalDirectly').value ? true : null">
            </mat-form-field>
            @if (categoryCtrl.get('expiryDay')?.errors?.['min']) {
            <small class="text-danger">{{ 'expenses.negativeValRestrict' | translate }}</small>
            }
            @if (categoryCtrl.get('expiryDay')?.errors?.['required']) {
            <small class="text-danger">{{ 'expenses.requiredFields' | translate }}</small>
            }
          </div>

          <div class="d-flex align-items-center mt-2">
            <label class="w-50">{{'expenses.max_expense' | translate}}</label>
            <mat-form-field class="ms-auto">
              <input type="number" min="0" matInput formControlName="maximumExpensesCanApply">
            </mat-form-field>
            @if (categoryCtrl.get('maximumExpensesCanApply').invalid) {
            <small class="text-danger">{{ 'expenses.negativeValRestrict' | translate }}</small>
            }
            @if (categoryCtrl.get('maximumExpensesCanApply')?.errors?.['required']) {
            <small class="text-danger">{{ 'expenses.requiredFields' | translate }}</small>
            }
          </div>
          }

          <div class="d-flex">
            <button class="ms-auto" mat-stroked-button color="primary" type="button"
              (click)="addField(i)">{{'expenses.add_fields' | translate }}</button>
          </div>
          @if(!categoryCtrl.get('expenseTemplateCategoryFieldValues').value.length){
          <div class="text-danger">{{'expenses.add_fields_error' | translate}}</div>
          }
          <div formArrayName="expenseTemplateCategoryFieldValues">
              <div
                *ngFor="let fieldCtrl of categoryCtrl.get('expenseTemplateCategoryFieldValues').controls; let j = index">
                <div [formGroupName]="j">
                  <div class="d-flex pt-2 align-items-center justify-content-between">
                    <mat-form-field [class.namemargin]="fieldCtrl.get('label').touched && fieldCtrl.get('label').invalid">
                      <mat-label>{{'expenses.categoryLabel' | translate}}</mat-label>
                      <input matInput formControlName="label" placeholder="Label" required>
                      <mat-error *ngIf="fieldCtrl.get('label').touched && fieldCtrl.get('label').invalid">
                        <span *ngIf="fieldCtrl.get('label').hasError('maxlength')">
                          {{'expenses.category_label_Limit' | translate}}
                        </span>
                        <span *ngIf="fieldCtrl.get('label')?.errors?.['spacesNotAllowed']">
                          {{ 'expenses.labelNoLeadingOrTrailingSpaces' | translate }}
                        </span>
                        <span *ngIf="fieldCtrl.get('label')?.errors?.['invalidLabel']">
                          {{ 'expenses.label_invalid' | translate }}
                        </span>
                        <span *ngIf="fieldCtrl.get('label').hasError('required')">
                          {{'expenses.label_for_expense_template_error' | translate}}
                        </span>
                      </mat-error>
                    </mat-form-field>

                    @if(categoryCtrl.get('categoryType').value === 'distance'){
                    <mat-form-field>
                      <mat-select formControlName="type" required>
                        <mat-option value="km">{{'expenses.km' | translate}}</mat-option>
                        <mat-option value="miles">{{'expenses.miles' | translate}}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    }
                    <mat-form-field>
                      <mat-label>{{'expenses.rate' | translate}}</mat-label>
                      <input matInput type="number" min="0" placeholder="Rate" formControlName="rate" required>
                      @if (fieldCtrl.get('rate')?.errors?.['min']) {
                      <mat-error>{{ 'expenses.negativeValRestrict' | translate }}</mat-error>
                      }
                      @if (fieldCtrl.get('rate')?.errors?.['required']) {
                      <mat-error>{{ 'expenses.requiredFields' | translate }}</mat-error>
                      }
                    </mat-form-field>
                    <button (click)="deleteCategoryField(i, j)" mat-icon-button type="button" color="warn">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
          </div>

          <div class="mt-3 text-end">
            @if(i>0){
            <button mat-button matStepperPrevious color="primary">{{'expenses.back' | translate}}</button>
            }
            <button mat-stroked-button matStepperNext color="primary">{{'expenses.next' | translate}}</button>
          </div>
        </form>
      </mat-step>
    </ng-container>
    <mat-step>
      <ng-template matStepLabel>Review</ng-template>

      @for(categoryCtrl of firstForm?.get('expenseCategories')?.controls; track categoryCtrl; let i = $index){
      <div class="mb-2">
        <h4 class="mb-1 fw-bold text-dark">{{ getCategoryLabel(categoryCtrl.value._id)}}</h4>
        <ul class="list-group border border-warning">
          @if(categoryCtrl.get('categoryType').value == 'dateRange'){
          <li class="list-group-item p-1 d-flex justify-content-between">
            {{'expenses.total_amount_allowed' | translate}}
            <b>{{categoryCtrl.value['isEmployeeCanAddInTotalDirectly']}}</b>
          </li>
          <li class="list-group-item p-1 d-flex justify-content-between">
            {{'expenses.rate_per_day' | translate}} <b>{{categoryCtrl.value['ratePerDay']}}</b>
          </li>
          }
          @if(categoryCtrl.value['isMaximumAmountPerExpenseSet']){
          <li class="list-group-item p-1 d-flex justify-content-between">
            {{'expenses.max_amount_limit_per_expense' | translate}}
            <b>{{categoryCtrl.value['maximumAmountPerExpense']}}</b>
          </li>
          }
          @if(categoryCtrl.value['isMaximumAmountWithoutReceiptSet']){
          <li class="list-group-item p-1 d-flex justify-content-between">
            {{'expenses.max_amount_limit_per_expense_without_receipt' | translate}}
            <b>{{categoryCtrl.value['maximumAmountWithoutReceipt']}}</b>
          </li>
          }
          @if(categoryCtrl.get('categoryType').value != 'dateRange'){
          @if(categoryCtrl.value['isTimePeroidSet']){
          <li class="list-group-item p-1 d-flex justify-content-between">
            {{'expenses.times_in_a' | translate}} <b>{{categoryCtrl.value['timePeroid']}}</b>
          </li>
          }
          <li class="list-group-item p-1 d-flex justify-content-between">
            {{'expenses.expire_after_days' | translate}} <b>{{categoryCtrl.value['expiryDay']}}</b>
          </li>
          <li class="list-group-item p-1 d-flex justify-content-between">
            {{'expenses.max_expense' | translate}} <b>{{categoryCtrl.value['maximumExpensesCanApply']}}</b>
          </li>
          }
        </ul>
        @if(categoryCtrl.get('expenseTemplateCategoryFieldValues').controls.length){
        <table class="mt-2 table table-bordered table-sm">
          <thead>
            <tr>
              <th translate>expenses.categoryLabel</th>
              @if(categoryCtrl.get('categoryType').value === 'distance'){
              <th translate>expenses.type</th>
              }
              <th translate>expenses.rate</th>
            </tr>
          </thead>
          <tbody>
            @for(field of categoryCtrl.get('expenseTemplateCategoryFieldValues').controls; track field;){
            <tr>
              <td>{{field.value.label}}</td>
              @if(categoryCtrl.get('categoryType').value === 'distance'){
              <td>{{field.value.type}}</td>
              }
              <td>{{field.value.rate}}</td>
            </tr>
            }
          </tbody>
        </table>
        }
      </div>
      }
      <div class="mt-3">
        <button mat-button matStepperPrevious color="primary">{{'expenses.back' | translate}}</button>
      </div>
    </mat-step>
  </mat-vertical-stepper>
  } @else {
  <h2>Loading...</h2>
  <p>Please wait while categories are loading.</p>
  }
</div>
<div mat-dialog-actions>
  <button mat-flat-button type="button" (click)="closeModal()">{{'expenses.cancel' | translate}}</button>
  <button mat-flat-button class="ms-auto" color="primary" [disabled]="firstForm?.invalid"
    (click)="onSubmit()">{{'expenses.submit' | translate}}</button>
</div>