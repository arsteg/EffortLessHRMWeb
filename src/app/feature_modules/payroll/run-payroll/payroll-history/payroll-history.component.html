<div class="main-content" *ngIf="isAllEmployees">
  <div class="container-fluid">
    <div class="bg-white mt-2">
      <div class="d-flex align-items-center px-2 py-1">
        <p class="mb-0 me-auto"> ({{totalRecords}}) {{ 'payroll.records_found' | translate}}</p>
        <div class="d-flex align-items-center">
          <span class="bi bi-search searchIcon"></span>
          <input class="form-control search" type="text"
                 [placeholder]="'payroll.search_placeholder' | translate"
                 [(ngModel)]="searchText" (input)="applyFilter()"
                 name="searchText" aria-label="Search payroll history">
          <button class="addBtn ms-2" mat-raised-button (click)="openAddDialog()">
            {{ 'payroll.add' | translate }}
          </button>
        </div>
      </div>
      <mat-table [dataSource]="dataSource">
        <ng-container matColumnDef="payrollPeriod">
          <mat-header-cell *matHeaderCellDef> {{ 'payroll._history.table.period' | translate }} </mat-header-cell>
          <mat-cell *matCellDef="let data"> {{ data?.month }} - {{ data?.year }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="date">
          <mat-header-cell *matHeaderCellDef> {{ 'payroll._history.table.date' | translate }} </mat-header-cell>
          <mat-cell *matCellDef="let data"> {{ data?.date | date:'mediumDate' }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="payrollDetails">
          <mat-header-cell *matHeaderCellDef> {{ 'payroll._history.table.details' | translate }} </mat-header-cell>
          <mat-cell *matCellDef="let data">
            <div class="d-flex align-items-center">
              <mat-icon matTooltipPosition="before" [matTooltip]="'payroll._history.table.processed' | translate: { count: data?.processedCount }"
                aria-label="Processed Employees">check_circle</mat-icon>
              <mat-icon matTooltipPosition="below" [matTooltip]="'payroll._history.table.active' | translate: { count: data?.activeCount }"
                aria-label="Active Employees">person</mat-icon>
              <mat-icon matTooltipPosition="after" [matTooltip]="'payroll._history.table.onhold' | translate: { count: data?.onHoldCount }"
                aria-label="On-Hold Employees">pause_circle</mat-icon>
            </div>
          </mat-cell>
        </ng-container>

        <ng-container matColumnDef="status">
          <mat-header-cell *matHeaderCellDef> {{ 'payroll._history.table.status' | translate }} </mat-header-cell>
          <mat-cell *matCellDef="let data">
            <mat-icon *ngIf="data?.status === 'InProgress'" [matTooltip]="'payroll._history.status.in_progress' | translate"
              aria-label="In Progress">hourglass_empty</mat-icon>
            <mat-icon *ngIf="data?.status === 'Complete Approval Pending'" [matTooltip]="'payroll._history.status.complete_approval' | translate"
              aria-label="Complete Approval Pending">hourglass_full</mat-icon>
            <mat-icon *ngIf="data?.status === 'OnHold'" [matTooltip]="'payroll._history.status.on_hold' | translate"
              aria-label="On Hold">pause_circle</mat-icon>
            <mat-icon *ngIf="data?.status === 'Processed'" [matTooltip]="'payroll._history.status.processed' | translate"
              aria-label="Processed">check_circle</mat-icon>
          </mat-cell>
        </ng-container>

        <ng-container matColumnDef="actions">
          <mat-header-cell *matHeaderCellDef> {{ 'payroll.actions' | translate }} </mat-header-cell>
          <mat-cell *matCellDef="let data">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="selectedPayroll = data?._id; openAddUserDialog()">
                <mat-icon>person_add</mat-icon>
                <span>{{ 'payroll._history.actions.add_employee' | translate }}</span>
              </button>
              <button mat-menu-item (click)="selectedPayroll = data; openSteps();">
                <mat-icon>edit</mat-icon>
                <span>{{ 'payroll.edit' | translate }}</span>
              </button>
              <button mat-menu-item (click)="deleteDialog(data._id)">
                <mat-icon>delete</mat-icon>
                <span>{{ 'payroll.delete' | translate }}</span>
              </button>
              <ng-container *ngFor="let status of payrollStatusArray">
                <button mat-menu-item *ngIf="status.toLowerCase() !== data?.status?.toLowerCase()" (click)="selectedPayroll = data; openUpdateStatusDialog(status)">
                  <span>{{ 'payroll._history.status.' + status.toLowerCase() | translate }}</span>
                </button>
              </ng-container>
            </mat-menu>
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
      </mat-table>
      <mat-paginator [length]="totalRecords" [pageSize]="pageSize"
                     [pageSizeOptions]="pageSizeOptions" (page)="onPageChange($event)"
                     aria-label="Select page of payroll history">
      </mat-paginator>
    </div>
  </div>
</div>

<ng-template #updateStatus>
  <h1 mat-dialog-title>{{ 'payroll._history.change_status' | translate: { status: selectedStatus } }}</h1>
  <div mat-dialog-content>
    <div class="d-flex justify-content-between">
      <button mat-raised-button type="button" (click)="closeAddDialog()">{{ 'payroll.close' | translate }}</button>
      <button mat-raised-button type="submit" color="primary" (click)="updatePayrollStatus()">
        {{ 'payroll._history.status.' + selectedStatus.toLowerCase() | translate }}
      </button>
    </div>
  </div>
</ng-template>

<ng-template #addDialogTemplate>
  <h1 mat-dialog-title>{{ 'payroll._history.create_payroll' | translate }}</h1>
  <div mat-dialog-content>
    <form [formGroup]="payrollForm" (ngSubmit)="onSubmission()">
      <div class="row">
        <mat-form-field appearance="outline" class="my-2 col-md-6">
          <mat-label>{{ 'payroll._history.form.month' | translate }}</mat-label>
          <mat-select formControlName="month">
            <mat-option *ngFor="let month of months" [value]="month">{{ month }}</mat-option>
          </mat-select>
          <mat-error *ngIf="payrollForm.get('month').hasError('required')">
            {{ 'payroll._history.form.month_required' | translate }}
          </mat-error>
        </mat-form-field>
        <div *ngIf="duplicatePayrollError" class="text-danger my-2">
          {{ 'payroll._history.form.duplicate_error' | translate }}
        </div>
        <mat-form-field appearance="outline" class="my-2 col-md-6">
          <mat-label>{{ 'payroll._history.form.year' | translate }}</mat-label>
          <mat-select formControlName="year">
            <mat-option *ngFor="let year of years" [value]="year">{{ year }}</mat-option>
          </mat-select>
          <mat-error *ngIf="payrollForm.get('year').hasError('required')">
            {{ 'payroll._history.form.year_required' | translate }}
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="col-md-6 my-2">
          <mat-label>{{ 'payroll._history.form.date' | translate }}</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="date">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="payrollForm.get('date').hasError('required')">
            {{ 'payroll._history.form.date_required' | translate }}
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="my-2 col-md-6">
          <mat-label>{{ 'payroll._history.form.status' | translate }}</mat-label>
          <mat-select formControlName="status">
            <mat-option value="" disabled>{{ 'payroll._history.form.select_status' | translate }}</mat-option>
            <mat-option value="InProgress">{{ 'payroll._history.status.in_progress' | translate }}</mat-option>
            <mat-option value="Complete Approval Pending">{{ 'payroll._history.status.complete_approval' | translate }}</mat-option>
            <mat-option value="OnHold">{{ 'payroll._history.status.on_hold' | translate }}</mat-option>
            <mat-option value="Processed">{{ 'payroll._history.status.processed' | translate }}</mat-option>
          </mat-select>
          <mat-error *ngIf="payrollForm.get('status').hasError('required')">
            {{ 'payroll._history.form.status_required' | translate }}
          </mat-error>
        </mat-form-field>
      </div>
    </form>
  </div>
  <div mat-dialog-actions>
    <button mat-button (click)="closeAddDialog()">{{ 'payroll.close' | translate }}</button>
    <button mat-raised-button color="primary" [disabled]="duplicatePayrollError" (click)="onSubmission()">
      {{ 'payroll.save' | translate }}
    </button>
  </div>
</ng-template>

<ng-template #addUserModal let-addUserModal>
  <h1 mat-dialog-title>{{ 'payroll._history.assign_employee' | translate }}</h1>
  <div mat-dialog-content>
    <form [formGroup]="payrollUserForm">
      <div class="row">
        <mat-form-field appearance="outline" class="col-md-6 my-2">
          <mat-label>{{ 'payroll._history.form.employee' | translate }}</mat-label>
          <mat-select formControlName="user" (selectionChange)="getGrossSalaryBySalaryStructure()">
            <mat-option *ngFor="let user of users" [value]="user?.id">{{ user?.firstName | titlecase }} {{ user.lastName | titlecase }}</mat-option>
          </mat-select>
          <mat-error *ngIf="payrollUserForm.get('user').touched && payrollUserForm.get('user').hasError('required')">
            {{ 'payroll._history.form.employee_required' | translate }}
          </mat-error>
          <mat-error *ngIf="payrollUserForm.get('user').valid && payrollUserForm.get('user').hasError('noSalary')">
            {{ 'payroll._history.form.no_salary' | translate }}
          </mat-error>
          <mat-error *ngIf="payrollUserForm.get('user').hasError('userExists')">
            {{ 'payroll._history.form.user_exists' | translate }}
          </mat-error>
        </mat-form-field>
      </div>
      <div class="row">
        <mat-form-field appearance="outline" class="col-md-6 my-2">
          <mat-label>{{ 'payroll._history.form.total_ctc' | translate }}</mat-label>
          <input matInput type="number" formControlName="totalCTC" [placeholder]="'payroll._history.form.enter_ctc' | translate">
        </mat-form-field>
      </div>
      <div class="row">
        <mat-form-field appearance="outline" class="col-md-6 my-2">
          <mat-label>{{ 'payroll._history.form.gross_salary' | translate }}</mat-label>
          <input matInput type="number" formControlName="totalGrossSalary" [placeholder]="'payroll._history.form.enter_gross_salary' | translate">
        </mat-form-field>
      </div>
      <mat-form-field appearance="outline" class="col-md-6 my-2">
        <mat-label>{{ 'payroll._history.form.status' | translate }}</mat-label>
        <mat-select formControlName="status">
          <mat-option value="Active">{{ 'payroll._history.status.active' | translate }}</mat-option>
          <mat-option value="Inactive">{{ 'payroll._history.status.inactive' | translate }}</mat-option>
        </mat-select>
      </mat-form-field>
    </form>
  </div>
  <div mat-dialog-actions>
    <button mat-button (click)="closeAddUserDialog()" type="button">{{ 'payroll.close' | translate }}</button>
    <button mat-raised-button color="primary" (click)="updatePayrollUser()" [disabled]="payrollUserForm.invalid" type="submit">
      {{ 'payroll.save' | translate }}
    </button>
  </div>
</ng-template>

<div *ngIf="!isAllEmployees">
  <button mat-raised-button class="bi bi-arrow-left addBtn" (click)="goBack()">{{ 'payroll.back' | translate }}</button>
  <app-payroll-steps [selectedPayroll]="selectedPayroll"></app-payroll-steps>
</div>