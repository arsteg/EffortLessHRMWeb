<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between border-bottom">
    <h3 class="mb-0">
      {{ view === 'admin' ? ('preferences.userSettings' | translate) : ('preferences.userPreferences' | translate) }}
    </h3>
  </div>

  <div class="row mt-3">
    <div class="col-12">
      <div *ngIf="isLoading | async; else preferencesForm" class="text-center py-5">
        <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
        <p class="mt-3">{{ 'preferences.loading' | translate }}</p>
      </div>

      <ng-template #preferencesForm>
        <form class="bg-white" (ngSubmit)="onSubmit()" *ngIf="explicitPreferences | async as explicitPreferences; else noPreferences">

          <div class="row">
            <div *ngIf="view === 'admin'" class="col-auto">
              <mat-form-field class="w-100 m-0">
                <mat-label>{{ 'preferences.selectUser' | translate }}</mat-label>
                <mat-select 
                  [(ngModel)]="selectedUsersByAdmin"
                  (selectionChange)="loadUserPreferences(selectedUsersByAdmin)" 
                  [ngModelOptions]="{ standalone: true }">
                  <mat-option *ngFor="let user of userList" [value]="user._id">
                    {{ user.firstName }} {{ user.lastName }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          <div class="row mb-3">
            <em class="text-muted small" *ngIf="view === 'admin'">
                {{ 'preferences.settingsInstruction' | translate }}
              </em>
          </div>

          <div class="row">
            <ng-container *ngFor="let pref of explicitPreferences">
              <div class="col-md-6 mb-3">
                <div class="form-group">
                  <mat-checkbox
                    *ngIf="pref.metadata?.inputType === 'checkbox'"
                    [checked]="userPreferences[pref.key] === 'true'"
                    (change)="userPreferences[pref.key] = $event.checked ? 'true' : 'false'; updateFormValidity()"
                    color="primary"
                  >
                    {{ pref.metadata?.label || pref.key }}
                  </mat-checkbox>

                  <mat-form-field *ngIf="pref.metadata?.inputType === 'number'" appearance="outline" class="w-100">
                    <mat-label>{{ pref.metadata?.label || pref.key }}</mat-label>
                    <input matInput
                      type="number"
                      [id]="pref.metadata?.id"
                      [name]="pref.metadata?.name"
                      [(ngModel)]="userPreferences[pref.key]"
                      (change)="updateFormValidity()"
                      [ngClass]="{ 'is-invalid': !formValid }"
                    />
                    <mat-error *ngIf="!formValid">
                      {{ 'preferences.invalid' | translate }} {{ pref.metadata?.label || pref.key }}!
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>
            </ng-container>
          </div>

          <div class="d-flex justify-content-end mt-3">
            <button mat-flat-button color="primary" type="submit" [disabled]="!formValid">
              {{ 'preferences.save' | translate }}
            </button>
          </div>
        </form>

        <ng-template #noPreferences>
          <p class="text-muted">{{ 'preferences.noExplicitPreferences' | translate }}</p>
        </ng-template>
      </ng-template>
    </div>
  </div>
</div>
