<div class="position-relative d-none d-md-block">
    <div class="d-flex justify-content-end position-absolute end-0">
        <ng-container *ngTemplateOutlet="header"></ng-container>
    </div>
</div>

<div class="d-block d-md-none pt-2">
    <div class="d-flex justify-content-start">
        <ng-container *ngTemplateOutlet="header"></ng-container>
    </div>
</div>

<ng-template #header>
    <div class="">
            <mat-form-field>
                <mat-label>Members</mat-label>
                <mat-select id="member" name="member" 
                    [(ngModel)]="userId" (selectionChange)="onMemberSelectionChange(userId)">
                    <mat-option value="" [selected] [disabled]>All Members</mat-option>
                    <mat-option *ngFor="let assignee of allAssignee" [value]="assignee.id">
                        {{assignee.firstName |titlecase}} {{assignee.lastName | titlecase}}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>
        <div class="ms-2 text-end">
            <button mat-flat-button color="primary" (click)="clearForm(); openModal(addModal)">
                Add New
            </button>
        </div>
</ng-template>



<div>
    <hrm-table [data]="projectList" [columns]="columns" (actionClicked)="onActionClick($event)" [isServerSide]="true"
        [showSearch]="true" [totalItems]="totalRecords" [pageSize]="recordsPerPage" (pageChanged)="onPageChange($event)"
        (searchChanged)="onSearchChange($event)" (sortChanged)="onSortChange($event)"></hrm-table>
</div>



<!-- Manage user modal -->
<ng-template #manageUsersModal>
    <div class="d-flex justify-content-between p-1">
         <h4 mat-dialog-title>
            {{ 'manage.project.manage_member_title' | translate }}
         </h4>
        <button type="button" mat-dialog-close mat-icon-button>
            <mat-icon>close</mat-icon>
        </button>
    </div>
    @if(selectedProject){
        <form (ngSubmit)="saveProjectUsers()">
        <div mat-dialog-content>
            <div *ngFor="let assignee of allAssignee" class="mt-2">
                <mat-checkbox color="primary" [checked]="isUserSelected(assignee.id)"
                    (change)="onCheckboxChange(assignee, $event.checked)">
                    {{ assignee.firstName | titlecase }} {{ assignee.lastName | titlecase }}
                </mat-checkbox>
            </div>
        </div>
        <div mat-dialog-actions class="d-flex justify-content-between mt-3">
            <button mat-flat-button class="mx-2" mat-dialog-close type="button">
                {{ 'manage.project.cancel' | translate }}
            </button>
            <button mat-flat-button color="primary" type="submit">
                {{ 'manage.project.save' | translate }}
            </button>
        </div>
    </form>
}
</ng-template>


<!-- Add User -->
<div class="modal" id="addUserModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class=" d-flex justify-content-between">
                    <div class="">
                        <h4 class="modal-title text-start">Add New Member</h4>
                    </div>
                    <div class=""><button type="button" data-bs-dismiss="modal" class="btn-close text-end"></button>
                    </div>
                </div>
                <hr class="mt-0">
                <div class="row" *ngIf="selectedProject">
                    <form class="row" [formGroup]="addUserForm" (ngSubmit)="addUserToProject(addUserForm.value)">
                        <div class="row d-flex justify-content-center">
                            <div class="col-md-8">
                                <div class="mt-3">
                                    <mat-form-field appearance="outline" class="w-100">
                                        <mat-label>Select User</mat-label>
                                        <mat-select multiple formControlName="userName" [(ngModel)]="selectedUser">
                                            <mat-option *ngFor="let assignee of allAssignee" [value]="assignee.id"
                                                [selected]="selectedUser?.includes(assignee?.id)">
                                                {{assignee.firstName | titlecase}} {{assignee.lastName | titlecase}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between m-3">
                            <div>
                                <button mat-flat-button class="mx-2" data-bs-dismiss="modal"
                                    type="button">Cancel</button>
                            </div>
                            <div>
                                <button mat-flat-button class="addBtn" data-bs-dismiss="modal"
                                    type="submit">Add</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Get Users List -->
<div class="modal" id="getUsers">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class=" d-flex justify-content-between">
                    <div class="">
                        <h4 class="modal-title text-start">Users Assigned to the <b
                                style="color: #76bc21">{{selectedProject?.projectName | titlecase}}</b></h4>
                    </div>
                    <div class=""><button type="button" data-bs-dismiss="modal" class="btn-close text-end"></button>
                    </div>
                </div>
                <hr class="mt-0">
                <div class="row" *ngIf="selectedProject">
                    <form class="row">
                        <div class="row d-flex justify-content-center">
                            <div class="col-md-8">
                                <li *ngFor="let assignee of projectUserList;" type="none">
                                    <label *ngIf="assignee.user!=null">
                                        <mat-checkbox color="primary" name="firstName"
                                            (change)="onModelChange(assignee)"
                                            [checked]="true">{{assignee?.user?.firstName | titlecase}}
                                            {{assignee?.user?.lastName | titlecase}}</mat-checkbox>
                                    </label>

                                </li>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add -->
<ng-template #addModal>
    <div class="d-flex align-items-center justify-content-between">
        <h1 mat-dialog-title>
        {{ 'manage.project.modal.add_title' | translate }}
        </h1>
        <button mat-icon-button mat-dialog-close="" class="me-4">
            <mat-icon>close</mat-icon>
        </button>
    </div>
    <form class="pt-2" [formGroup]="form" (ngSubmit)="addProject()">
        <mat-dialog-content>
            <div class="row d-flex justify-content-center">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-6">
                            <mat-form-field class="w-100">
                                <mat-label>{{ 'manage.project.form.project_name' | translate }}</mat-label>
                                <input matInput type="text" formControlName="projectName">
                                <mat-error *ngIf="form.get('projectName')?.invalid && (form.get('projectName')?.touched || form.get('projectName')?.dirty)">
                                    <ng-container *ngIf="form.get('projectName')?.errors?.['required']; else spaceError">
                                    {{ 'manage.project.form.error.project_name_required' | translate }}
                                    </ng-container>
                                    <ng-template #spaceError>
                                    <ng-container *ngIf="form.get('projectName')?.errors?.['spacesNotAllowed']">
                                        {{ 'manage.project.form.error.whitespace_error' | translate }}
                                    </ng-container>
                                    </ng-template>
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <div class="col-md-6">
                            <mat-form-field class="w-100">
                                <mat-label>
                                {{ 'manage.project.form.estimated_time' | translate }}
                                <span class="text-muted" style="font-size: 12px"> ({{ 'manage.project.form.in_hours' | translate }})</span>
                                </mat-label>
                                <input matInput type="number" formControlName="estimatedTime">
                                <mat-error
                                *ngIf="form.get('estimatedTime')?.invalid && (form.get('estimatedTime')?.touched || form.get('estimatedTime')?.dirty)">
                                <span *ngIf="form.get('estimatedTime')?.errors?.['required']">
                                    {{ 'manage.project.form.error.estimated_time_required' | translate }}
                                </span>
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>


                    <div class="row mt-2">
                        <div class="col-md-6">
                            <mat-form-field class="w-100">
                                <mat-label>{{ 'manage.project.form.start_date' | translate }}</mat-label>
                                <input matInput [matDatepicker]="picker" formControlName="startDate">
                                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                                <mat-error
                                *ngIf="form.get('startDate')?.invalid && (form.get('startDate')?.touched || form.get('startDate')?.dirty)">
                                <span *ngIf="form.get('startDate')?.errors?.['required']">
                                    {{ 'manage.project.form.error.start_date_required' | translate }}
                                </span>
                                </mat-error>
                            </mat-form-field>
                        </div>


                        <div class="col-md-6">
                            <mat-form-field class="w-100">
                                <mat-label>{{ 'manage.project.form.end_date' | translate }}</mat-label>
                                <input matInput [matDatepicker]="pickerend" formControlName="endDate">
                                <mat-datepicker-toggle matSuffix [for]="pickerend"></mat-datepicker-toggle>
                                <mat-datepicker #pickerend></mat-datepicker>
                                <mat-error
                                *ngIf="form.get('endDate')?.invalid && (form.get('endDate')?.touched || form.get('endDate')?.dirty)">
                                <span *ngIf="form.get('endDate')?.errors?.['required']">
                                    {{ 'manage.project.form.error.end_date_required' | translate }}
                                </span>
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                    <div class="form-group mt-2 col-md-12">
                        <mat-form-field class="w-100">
                        <mat-label>{{ 'manage.project.form.notes' | translate }}</mat-label>
                        <input matInput type="text" formControlName="notes">
                        <mat-error *ngIf="form.get('notes')?.invalid && (form.get('notes')?.touched || form.get('notes')?.dirty)">
                            <ng-container *ngIf="form.get('notes')?.errors?.['required']; else spaceError">
                                {{ 'manage.project.form.error.notes_required' | translate }}
                            </ng-container>
                            <ng-template #spaceError>
                                <ng-container *ngIf="form.get('notes')?.errors?.['spacesNotAllowed']">
                                {{ 'manage.project.form.error.whitespace_error' | translate }}
                                </ng-container>
                            </ng-template>
                        </mat-error>
                        </mat-form-field>
                    </div>
                </div>
            </div>
        </mat-dialog-content>
        <div mat-dialog-actions class="d-flex align-items-center justify-content-between">
            <button mat-flat-button mat-dialog-close>
            {{ 'manage.project.cancel' | translate }}
            </button>
            <button mat-flat-button color="primary" type="submit">
            {{ 'manage.project.add' | translate }}
            </button>
        </div>
        </form>
</ng-template>

<!-- Update -->
<ng-template #updateModal>
    <div class="d-flex align-items-center justify-content-between">
        <h1 mat-dialog-title>
            {{ 'manage.project.modal.update_title' | translate }} <b style="color: var(--orange-60);">{{selectedProject.projectName | titlecase}}</b>
        </h1>
        <button mat-icon-button mat-dialog-close="" class="me-4">
            <mat-icon>close</mat-icon>
        </button>
    </div>
    @if(selectedProject){
        <form [formGroup]="updateForm" (ngSubmit)="updateProject(updateForm.value)">
        <div mat-dialog-content>
            <div class="row m-0">
                <div class="col-md-12">
                    <div class="form-group col-12">
                        <mat-form-field class="w-100">
                        <mat-label>{{ 'manage.project.form.project_name' | translate }}</mat-label>
                        <input matInput type="text" [(ngModel)]="selectedProject.projectName" formControlName="projectName">
                        <mat-error *ngIf="updateForm.get('projectName')?.invalid && (updateForm.get('projectName')?.touched || updateForm.get('projectName')?.dirty)">
                            <ng-container *ngIf="updateForm.get('projectName')?.errors?.['required']; else spaceError">
                                {{ 'manage.project.form.error.project_name_required' | translate }}
                            </ng-container>
                            <ng-template #spaceError>
                                <ng-container *ngIf="updateForm.get('projectName')?.errors?.['spacesNotAllowed']">
                                    {{ 'manage.project.form.error.whitespace_error' | translate }}
                                </ng-container>
                            </ng-template>
                        </mat-error>
                        </mat-form-field>
                    </div>

                    <div class="row">
                        <div class="form-group col-md-6">
                        <mat-form-field class="w-100">
                            <mat-label>{{ 'manage.project.form.start_date' | translate }}</mat-label>
                             <input [(ngModel)]="selectedProject.startDate" matInput [matDatepicker]="picker" formControlName="startDate">
                                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                            <mat-error
                            *ngIf="updateForm.get('startDate')?.invalid && (updateForm.get('startDate')?.touched || updateForm.get('startDate')?.dirty)">
                            <span *ngIf="updateForm.get('startDate')?.errors?.['required']">
                                {{ 'manage.project.error.start_date_required' | translate }}
                            </span>
                            </mat-error>
                        </mat-form-field>
                        </div>

                        <div class="form-group col-md-6">
                        <mat-form-field class="w-100">
                            <mat-label>{{ 'manage.project.form.end_date' | translate }}</mat-label>
                             <input [(ngModel)]="selectedProject.endDate" matInput [matDatepicker]="pickerenddate" formControlName="endDate">
                                <mat-datepicker-toggle matSuffix [for]="pickerenddate"></mat-datepicker-toggle>
                                <mat-datepicker #pickerenddate></mat-datepicker>
                            <mat-error
                            *ngIf="updateForm.get('endDate')?.invalid && (updateForm.get('endDate')?.touched || updateForm.get('endDate')?.dirty)">
                            <span *ngIf="updateForm.get('endDate')?.errors?.['required']">
                                {{ 'manage.project.form.error.end_date_required' | translate }}
                            </span>
                            </mat-error>
                        </mat-form-field>
                        </div>
                    </div>

                    <div class="form-group col-12">
                        <mat-form-field class="w-100">
                        <mat-label>
                            {{ 'manage.project.form.estimated_time' | translate }}
                            <span class="text-muted" style="font-size: 12px"> ({{ 'manage.project.form.in_hours' | translate }})</span>
                        </mat-label>
                        <input matInput [(ngModel)]="selectedProject.estimatedTime" type="number" formControlName="estimatedTime">
                        <mat-error
                            *ngIf="updateForm.get('estimatedTime')?.invalid && (updateForm.get('estimatedTime')?.touched || updateForm.get('estimatedTime')?.dirty)">
                            <span *ngIf="updateForm.get('estimatedTime')?.errors?.['required']">
                            {{ 'manage.project.form.error.estimated_time_required' | translate }}
                            </span>
                            <span *ngIf="updateForm.get('estimatedTime')?.errors?.['pattern']">
                            {{ 'manage.project.form.error.estimated_time_pattern' | translate }}
                            </span>
                        </mat-error>
                        </mat-form-field>
                    </div>

                    <div class="form-group col-12">
                        <mat-form-field class="w-100">
                        <mat-label>{{ 'manage.project.form.notes' | translate }}</mat-label>
                        <input [(ngModel)]="selectedProject.notes" matInput type="text" formControlName="notes">
                        <mat-error *ngIf="updateForm.get('notes')?.invalid && (updateForm.get('notes')?.touched || updateForm.get('notes')?.dirty)">
                            <ng-container *ngIf="updateForm.get('notes')?.errors?.['required']; else spaceError">
                                {{ 'manage.project.form.error.notes_required' | translate }}
                            </ng-container>
                            <ng-template #spaceError>
                                <ng-container *ngIf="updateForm.get('notes')?.errors?.['spacesNotAllowed']">
                                    {{ 'manage.project.form.error.whitespace_error' | translate }}
                                </ng-container>
                            </ng-template>
                        </mat-error>
                        <!-- <mat-error
                            *ngIf="updateForm.get('notes')?.invalid && (updateForm.get('notes')?.touched || updateForm.get('notes')?.dirty)">
                            <span *ngIf="updateForm.get('notes')?.errors?.['required']">
                            {{ 'manage.project.form.error.notes_required' | translate }}
                            </span>
                        </mat-error> -->
                        </mat-form-field>
                    </div>
                </div>
            </div>
        </div>
        <div mat-dialog-actions class="d-flex align-items-center justify-content-between">
            <button mat-flat-button mat-dialog-close>
                {{ 'manage.project.cancel' | translate }}
            </button>
            <button mat-flat-button color="primary" type="submit">
                {{ 'manage.project.update' | translate }}
            </button>
        </div>
        </form>
    }

</ng-template>

<!-- Delete -->
<ng-template #deleteModal>
    <div>
        <h2 mat-dialog-title class="d-flex align-items-center mb-0 p-2 border border-bottom text-danger">
            <mat-icon>warning</mat-icon>
            {{'confirm_deletion' | translate}}
        </h2>
    </div>
    <div mat-dialog-content>
        <p translate>deletion_warning_msg</p>
    </div>
    <mat-dialog-actions class="d-flex justify-content-between">
        <button mat-flat-button mat-dialog-close>
            {{'cancel' | translate}}
        </button>
        <button mat-flat-button cdkFocusInitial color="warn" (click)="deleteProject()" mat-dialog-close>
            <mat-icon>delete</mat-icon>  {{'delete' | translate}}
        </button>
    </mat-dialog-actions>

</ng-template>