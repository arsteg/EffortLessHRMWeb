<div class="row mt-2">
  <div class="col-auto">
    <subordinateSelection (selectedUsersChange)="selectedUser = $event; filterData()"></subordinateSelection>
  </div>

  <div class="col-auto">
    <mat-form-field appearance="outline">
      <mat-label>{{ 'reports.timeline.select_project' | translate }}</mat-label>
      <mat-select multiple [(ngModel)]="selectedProject">
        <mat-option *ngFor="let project of projectList" [value]="project?.id" (click)="filterData()"
          [selected]="selectedProject?.includes(project?.id)">
          {{project?.projectName | titlecase}}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="col-auto d-flex align-items-baseline">
    <label class="pt-2">{{ 'reports.timeline.date' | translate }}</label>
    <span (click)="SetPreviousDay()" class="fa fa-angle-left fa-lg p-3"></span>
    <input type="date" name="fromDate" class="form-control calendar mx-1" id="fromDate" (change)="filterData()"
      [(ngModel)]="selectedDate" />
    <span (click)="SetNextDay()" class="fa fa-angle-right fa-lg p-3"></span>
  </div>

  <div class="col-auto">
    <button mat-icon-button (click)="refresh()" title="Refresh Timeline">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  <div class="col-auto">
    <div class="dropdown">
      <button mat-icon-button matTooltip="Download" matTooltipPosition="below"
          class="me-2" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
          <mat-icon>download</mat-icon>
        </button>
      <ul class="dropdown-menu p-0" aria-labelledby="dropdownMenuButton1" id="dropdown-export">
        <li><a class="export-button" (click)="exportToCsv()">{{ 'reports.timeline.csv' | translate }}</a></li>
        <li><a class="export-button" (click)="exportToExcel()">{{ 'reports.timeline.xls' | translate }}</a></li>
        <li><a class="export-button" (click)="exportToPdf()">{{ 'reports.timeline.pdf' | translate }}</a></li>
      </ul>
    </div>
  </div>
</div>

<div class="row py-2">
  <div class="col-md-10 d-flex flex-wrap gap-md-3 gap-1">
    <div class="d-flex align-items-center gap-1">
      <label class="type-tracked d-flex align-items-center">
        <input type="checkbox" checked="" value="tracked" (change)="toggleLogsVisibility('tracked')">
        <span class="type-tracked__control tracked"></span>
        <span class="type-tracked__label">{{ 'reports.timeline.tracked' | translate }}</span>
      </label>
    </div>
    <div class="d-flex align-items-center gap-1">
      <label class="type-tracked d-flex align-items-center">
        <input type="checkbox" checked="" value="medium" (change)="toggleLogsVisibility('medium')">
        <span class="type-tracked__control medium"></span>
        <span class="type-tracked__label">{{ 'reports.timeline.medium_activity' | translate }}</span>
      </label>
    </div>
    <div class="d-flex align-items-center gap-1">
      <label class="type-tracked d-flex align-items-center">
        <input type="checkbox" checked="" value="manual" (change)="toggleLogsVisibility('manual')">
        <span class="type-tracked__control manual"></span>
        <span class="type-tracked__label">{{ 'reports.timeline.manual' | translate }}</span>
      </label>
    </div>
    <div class="d-flex align-items-center gap-1">
      <label class="type-tracked d-flex align-items-center">
        <input type="checkbox" checked="" value="low" (change)="toggleLogsVisibility('low')">
        <span class="type-tracked__control low"></span>
        <span class="type-tracked__label">{{ 'reports.timeline.low_activity' | translate }}</span>
      </label>
    </div>
  </div>
</div>

<table class="hrm-table" id="timeSheet" #timeSheet>
  <thead>
    <tr>
      <th class="pe-lg-0 pe-5" scope="col" *ngIf="showMembersColumn" [appSort]="timeline" data-order="{{ sortOrder }}"
        data-name="logs" (click)="sortOrder = (sortOrder === 'asc' ? 'desc' : 'asc')">
        {{ 'reports.timeline.users' | translate }}&nbsp;<i [class]="sortOrder === 'asc' ? 'bi bi-arrow-up sort-asc' : 'bi bi-arrow-down sort-desc'"></i>
      </th>

      <th class="pe-lg-0 pe-5" scope="col" *ngIf="showProjectsColumn" [appSort]="timeline" data-order="{{ sortOrder }}"
        data-name="logs" (click)="sortOrder = (sortOrder === 'asc' ? 'desc' : 'asc')">
        {{ 'reports.timeline.projects' | translate }}&nbsp;<i [class]="sortOrder === 'asc' ? 'bi bi-arrow-up sort-asc' : 'bi bi-arrow-down sort-desc'"></i>
      </th>

      <th class="pe-lg-0 pe-5" scope="col" [appSort]="timeline" data-order="{{ sortOrder }}" data-name="logs"
        (click)="sortOrder = (sortOrder === 'asc' ? 'desc' : 'asc')">
        {{ 'reports.timeline.time' | translate }}&nbsp;<i [class]="sortOrder === 'asc' ? 'bi bi-arrow-up sort-asc' : 'bi bi-arrow-down sort-desc'"></i>
      </th>

      <th class="pe-lg-0 pe-4 text-center" *ngFor="let hour of hours" scope="col" width="60">
        {{ formattedStartTimeHour(hour) }}
      </th>
    </tr>
  </thead>

  <tbody>
    <tr *ngFor="let data of timeline;  let i = index;">
      <td *ngIf="showMembersColumn">
        <span class="letter d-lg-inline d-none mx-1"
          [style.background-color]="commonservice.getRandomColor(data?.logs[0]?.user?.lastName)">{{data?.logs[0]?.user?.firstName.slice(0,1)
          | uppercase}}{{data?.logs[0]?.user?.lastName.slice(0,1) | uppercase}}</span>
        {{data?.logs[0]?.user?.firstName | titlecase}}&nbsp;{{data?.logs[0]?.user?.lastName | titlecase}}
      </td>

      <td *ngIf="showProjectsColumn">{{data?.logs[0]?.project?.projectName}}</td>

      <td>
        {{ minutesToTime(data?.logs.length * 10) }}
      </td>

      <td *ngFor="let hour of hours" [style.padding]="0" class="hour report_time">
        <ng-container *ngFor="let log of data.logs">
          <div class="hour-container" *ngIf="isLogInHour(log, startTime.getHours() + hour) &&
            ((trackedChecked && getLogColor(log) === '#2ECD6F') ||
              (mediumChecked && getLogColor(log) === '#FFC107') ||
              (lowChecked && getLogColor(log) === '#ff0000') ||
              (manualChecked && getLogColor(log) === '#f87a3b'))" [style.height.px]="35"
            [style.width.px]="getLogWidth(log)" [style.background-color]="getLogColor(log)"
            [tooltip]="getLogTitle(log)" [style.margin-left.px]="getLogMarginLeft(log)"
            [style.background-color]="getLogColor(log)">
          </div>
        </ng-container>
      </td>
    </tr>
  </tbody>
</table>
